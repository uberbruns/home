#!/usr/bin/env python3
"""Extract Safari bookmarks via plist and print as: folder/title  url"""

import argparse
import fnmatch
import os
import plistlib
import shutil


PLIST_PATH = os.path.expanduser("~/Library/Safari/Bookmarks.plist")


# --------------------------------------------------------------------------- #
# Extraction
# --------------------------------------------------------------------------- #

def extract_bookmarks(node, folder=""):
    """Walk the bookmark tree, yielding (path, url) tuples. Paths use /."""
    bookmark_type = node.get("WebBookmarkType", "")

    if bookmark_type == "WebBookmarkTypeList":
        title = node.get("Title", "")
        child_folder = f"{folder}/{title}" if folder else title
        for child in node.get("Children", []):
            yield from extract_bookmarks(child, child_folder)

    elif bookmark_type == "WebBookmarkTypeLeaf":
        title = node.get("URIDictionary", {}).get("title", "") or url
        url = node.get("URLString", "")
        if not url:
            return
        yield folder, title, url


def filter_bookmarks(bookmarks, root="", includes=None, excludes=None):
    """Filter bookmarks by root prefix and include/exclude glob patterns.

    - root: only show bookmarks under this path prefix (stripped from output)
    - includes: if given, path must match at least one pattern (OR semantics)
    - excludes: if any pattern matches, the bookmark is excluded (takes precedence)
    """
    root_prefix = root + "/" if root else ""

    for folder, title, url in bookmarks:
        # Build full path for filtering
        path = f"{folder}/{title}" if folder else title

        # Apply root filter
        if root and not path.startswith(root):
            continue

        # Strip root prefix from folder
        if root_prefix and folder.startswith(root_prefix):
            display_folder = folder[len(root_prefix):]
        elif root and folder == root:
            display_folder = ""
        else:
            display_folder = folder
        display_path = f"{display_folder}/{title}" if display_folder else title

        # Apply exclude patterns (takes precedence)
        if excludes and any(fnmatch.fnmatch(display_path, p) for p in excludes):
            continue

        # Apply include patterns (OR semantics)
        if includes and not any(fnmatch.fnmatch(display_path, p) for p in includes):
            continue

        yield display_folder, title, url


# --------------------------------------------------------------------------- #
# Formatting
# --------------------------------------------------------------------------- #

def format_path(path, delimiter):
    """Replace / with the output delimiter."""
    return path.replace("/", delimiter) if delimiter != "/" else path


def truncate(text, max_length):
    """Shorten text to max_length with trailing ellipsis."""
    if len(text) <= max_length:
        return text
    return text[:max_length - 1] + "â€¦"


def print_formatted(bookmarks, delimiter, columns, max_path=0, max_url=0):
    """Print bookmarks with path and url truncated to fit terminal width."""
    path_limit = max_path if max_path > 0 else columns // 2

    for folder, title, url in bookmarks:
        path = format_path(f"{folder}/{title}" if folder else title, delimiter)
        display_path = truncate(path, path_limit)
        url_limit = max_url if max_url > 0 else max(columns - len(display_path) - 2, 20)
        display_url = truncate(url, url_limit)
        print(f"{display_path}  {display_url}")


def print_raw(bookmarks, delimiter):
    """Print bookmarks as tab-separated folder, title, and url."""
    for folder, title, url in bookmarks:
        print(f"{format_path(folder, delimiter)}\t{title}\t{url}")


# --------------------------------------------------------------------------- #
# Main
# --------------------------------------------------------------------------- #

def main():
    """Extract and display Safari bookmarks.

    Reads ~/Library/Safari/Bookmarks.plist and prints bookmarks as
    folder/title  url, with optional filtering and truncation.
    """
    parser = argparse.ArgumentParser(description="Extract Safari bookmarks")
    parser.add_argument("-1", "--raw", dest="raw", action="store_true",
                        help="machine-readable output: tab-separated, no truncation (default: off)")
    parser.add_argument("-d", "--delimiter", default="/",
                        help="output folder delimiter (default: /)")
    parser.add_argument("-e", "--exclude", action="append", default=[],
                        help="exclude paths matching glob pattern, repeatable (default: none)")
    parser.add_argument("-i", "--include", action="append", default=[],
                        help="include only paths matching glob pattern, repeatable, OR semantics (default: all)")
    parser.add_argument("-r", "--root", default="",
                        help="root folder prefix to filter by, uses / as delimiter (default: none)")
    parser.add_argument("-t", "--truncate", type=int, default=0,
                        help="truncate path to N characters, 0 = auto (default: 0)")
    parser.add_argument("-u", "--truncate-url", type=int, default=0,
                        help="truncate url to N characters, 0 = auto (default: 0)")
    args = parser.parse_args()

    # Read plist
    with open(PLIST_PATH, "rb") as f:
        plist = plistlib.load(f)

    # Extract and filter
    bookmarks = filter_bookmarks(
        extract_bookmarks(plist),
        root=args.root,
        includes=args.include or None,
        excludes=args.exclude or None,
    )

    # Print
    if args.raw:
        print_raw(bookmarks, args.delimiter)
    else:
        print_formatted(bookmarks, args.delimiter,
                        shutil.get_terminal_size().columns,
                        args.truncate, args.truncate_url)


if __name__ == "__main__":
    main()
