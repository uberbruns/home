#!/usr/bin/env python3
"""Emoji picker using fzf.

Selecting an emoji copies it to the clipboard and exits 0.
Escape exits 1 without copying.
"""

import json
import os
import subprocess
import sys


# --------------------------------------------------------------------------- #
# Configuration
# --------------------------------------------------------------------------- #

EMOJI_DATA = os.path.join(
    os.path.dirname(__file__),
    "../externals/milesj/emojibase/packages/data/en/compact.raw.json",
)

LINE_WIDTH = 84

FZF_ARGS = [
    "fzf", "--ansi", "--prompt=❯ ", "--no-hscroll",
    "--color=16",
    "--color=prompt:15,bg+:0,fg+:15:regular,hl:regular,hl+:regular,gutter:0,pointer:15",
    "--pointer=▌", "--no-scrollbar",
    "--delimiter=\t", "--nth=1", "--with-nth=2", "-i",
    "--bind", "enter:accept",
]


# --------------------------------------------------------------------------- #
# Implementation
# --------------------------------------------------------------------------- #

def build_index():
    """Build fzf input from emojibase data.

    Only includes entries with tags. Tags are searchable but not displayed.
    Index format: search_terms \\t display \\t emoji
    """
    with open(EMOJI_DATA) as f:
        entries = json.load(f)

    lines = []
    for entry in entries:
        tags = entry.get("tags")
        if not tags:
            continue

        emoji = entry["unicode"]
        label = entry["label"]

        # Search terms: label + all tags (searchable via --nth=1)
        search_terms = f"{label} {' '.join(tags)}"

        # Display: emoji + label, tags right-aligned in gray
        title = f"{emoji}  {label.title()}"
        tag_text = ", ".join(tags)
        padding = " " * max(4, LINE_WIDTH - len(title) - len(tag_text))
        display = f"{title}{padding}\033[90m{tag_text}\033[0m"

        lines.append(f"{search_terms}\t{display}\t{emoji}")
    return "\n".join(lines)


def pick_emoji(index):
    """Run fzf and return the selected emoji, or None on cancel."""
    result = subprocess.run(FZF_ARGS, input=index, text=True, capture_output=True)
    if result.returncode != 0 or not result.stdout.strip():
        return None
    return result.stdout.strip().split("\t")[2]


# --------------------------------------------------------------------------- #
# Main
# --------------------------------------------------------------------------- #

def main():
    index = build_index()
    emoji = pick_emoji(index)
    if not emoji:
        sys.exit(1)

    subprocess.run(["pbcopy"], input=emoji, text=True)
    print(f"Copied {emoji}")


if __name__ == "__main__":
    main()
