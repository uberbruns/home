#!/usr/bin/env python3
"""Emoji picker using fzf.

Selecting an emoji copies it to the clipboard and exits 0.
Escape exits 1 without copying.
"""

import ctypes
import subprocess
import sys
import unicodedata


# --------------------------------------------------------------------------- #
# Configuration
# --------------------------------------------------------------------------- #

FZF_ARGS = [
    "fzf", "--prompt=‚ùØ ", "--no-hscroll", "--border=bold",
    "--delimiter=\t", "--nth=1", "--with-nth=2", "-i",
    "--bind", "enter:accept",
]

EMOJI_RANGES = [
    (0x1F600, 0x1F64F),  # Emoticons
    (0x1F300, 0x1F5FF),  # Misc Symbols and Pictographs
    (0x1F680, 0x1F6FF),  # Transport and Map
    (0x1F900, 0x1F9FF),  # Supplemental Symbols and Pictographs
    (0x1FA70, 0x1FAFF),  # Symbols and Pictographs Extended-A
    (0x1F1E0, 0x1F1FF),  # Flags
]

SKIP = set(range(0x1F3FB, 0x1F400))  # Skin tone modifiers


# --------------------------------------------------------------------------- #
# Implementation
# --------------------------------------------------------------------------- #

_libc = ctypes.CDLL("libSystem.B.dylib")
_libc.wcwidth.argtypes = [ctypes.c_wchar]
_libc.wcwidth.restype = ctypes.c_int


def build_index():
    """Build fzf input: search_name \\t display \\t emoji per line."""
    lines = []
    seen = set()
    for start, end in EMOJI_RANGES:
        for cp in range(start, end + 1):
            if cp in SKIP:
                continue
            char = chr(cp)
            if char in seen:
                continue
            try:
                name = unicodedata.name(char)
            except ValueError:
                continue
            if _libc.wcwidth(char) != 2:
                continue
            seen.add(char)
            search_name = name.lower()
            display = f"{char}  {name.title()}"
            lines.append(f"{search_name}\t{display}\t{char}")
    return "\n".join(lines)


def pick_emoji(index):
    """Run fzf and return the selected emoji, or None on cancel."""
    result = subprocess.run(FZF_ARGS, input=index, text=True, capture_output=True)
    if result.returncode != 0 or not result.stdout.strip():
        return None
    return result.stdout.strip().split("\t")[2]


# --------------------------------------------------------------------------- #
# Main
# --------------------------------------------------------------------------- #

def main():
    index = build_index()
    emoji = pick_emoji(index)
    if not emoji:
        sys.exit(1)

    subprocess.run(["pbcopy"], input=emoji, text=True)
    print(f"Copied {emoji}")


if __name__ == "__main__":
    main()
